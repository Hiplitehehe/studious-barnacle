<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Notes</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; }
        textarea { width: 100%; height: 100px; }
        button { margin-top: 10px; }
        .note { border: 1px solid #ccc; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>GitHub Notes</h2>
    
    <textarea id="noteInput" placeholder="Write your note here..."></textarea>
    <button onclick="saveNote()">Save Note</button>
    
    <h3>Saved Notes</h3>
    <div id="notesContainer"></div>

    <script>
        const GITHUB_USERNAME = "Hiplitehehe";
        const REPO_NAME = "Notes";
        const FILE_PATH = "j.json";
        const TOKEN_URL = "https://lively-recipe-4eca.hiplitehehe.workers.dev/";

        let githubToken = "";

        async function fetchToken() {
            try {
                const response = await fetch(TOKEN_URL);
                if (!response.ok) throw new Error("Failed to fetch token");
                githubToken = await response.text();
                fetchNotes(); // Load notes after getting token
            } catch (error) {
                console.error("Error fetching token:", error);
            }
        }

        async function fetchNotes() {
            if (!githubToken) return;

            const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${githubToken}`, "Accept": "application/vnd.github.v3+json" }
            });

            if (!response.ok) {
                console.error("Failed to fetch notes.");
                return;
            }

            const data = await response.json();
            const content = atob(data.content);
            try {
                const notes = JSON.parse(content);
                displayNotes(notes);
            } catch {
                console.error("Invalid JSON format.");
            }
        }

        async function saveNote() {
            let noteText = document.getElementById("noteInput").value.trim();
            if (!noteText || !githubToken) return;

            // Fetch existing notes
            const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
            const getResponse = await fetch(url, {
                headers: { Authorization: `Bearer ${githubToken}`, "Accept": "application/vnd.github.v3+json" }
            });

            let notes = [];
            let sha = "";
            if (getResponse.ok) {
                const data = await getResponse.json();
                sha = data.sha;
                notes = JSON.parse(atob(data.content));
            }

            // Append new note
            notes.push({ text: noteText, timestamp: new Date().toISOString() });

            // Save updated notes
            const updatedContent = btoa(JSON.stringify(notes, null, 2));
            const putResponse = await fetch(url, {
                method: "PUT",
                headers: {
                    Authorization: `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Add new note",
                    content: updatedContent,
                    sha
                })
            });

            if (putResponse.ok) {
                document.getElementById("noteInput").value = "";
                fetchNotes();
            } else {
                console.error("Failed to save note.");
            }
        }

        function displayNotes(notes) {
            const container = document.getElementById("notesContainer");
            container.innerHTML = "";
            notes.forEach(note => {
                let div = document.createElement("div");
                div.className = "note";
                div.textContent = `${note.text} (Saved at: ${note.timestamp})`;
                container.appendChild(div);
            });
        }

        // Fetch GitHub token and load notes on page load
        fetchToken();
    </script>
</body>
</html>
